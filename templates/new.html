<!DOCTYPE html>
<html>
<head>
    <title>Realistic 3D House Plan Generator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --background-dark: #0a192f;
            --background-light: #f8f9fa;
            --text-light: #e6f1ff;
            --text-dark: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-light);
            color: var(--text-dark);
        }

        #container {
            display: flex;
            height: 100vh;
        }

        #form-panel {
            width: 350px;
            padding: 20px;
            background: #fff;
            box-shadow: var(--shadow);
            overflow-y: auto;
            transition: var(--transition);
        }

        #3d-view {
            flex-grow: 1;
            background: #e0e0e0;
            position: relative;
        }

        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            margin-top: 0;
        }

        h3 {
            color: var(--secondary-color);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-dark);
        }

        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            transition: var(--transition);
        }

        input:focus, select:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-color);
        }

        .feature-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            box-shadow: var(--shadow);
        }

        .add-btn {
            background: var(--accent-color);
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
            margin-top: 5px;
        }

        .remove-btn {
            background: #f44336;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .tab-container {
            display: flex;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 15px;
            background: #eee;
            border: none;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 200;
            display: none;
        }

        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            
            #form-panel {
                width: 100%;
                height: 300px;
            }
            
            #3d-view {
                height: calc(100vh - 300px);
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
<div id="container">
    <div id="form-panel">
        <h2>Realistic 3D House Generator</h2>
        
        <div class="tab-container">
            <button class="tab active" onclick="openTab('dimensions')">Dimensions</button>
            <button class="tab" onclick="openTab('rooms')">Rooms</button>
            <button class="tab" onclick="openTab('features')">Features</button>
        </div>
        
        <div id="dimensions" class="tab-content active">
            <div class="form-group">
                <label for="house-width">House Width (m):</label>
                <input type="number" id="house-width" min="5" max="50" value="12" step="0.1">
            </div>

            <div class="form-group">
                <label for="house-depth">House Depth (m):</label>
                <input type="number" id="house-depth" min="5" max="50" value="10" step="0.1">
            </div>

            <div class="form-group">
                <label for="house-height">House Height (m):</label>
                <input type="number" id="house-height" min="2" max="20" value="3.5" step="0.1">
            </div>

            <div class="form-group">
                <label for="roof-type">Roof Type:</label>
                <select id="roof-type">
                    <option value="gable">Gable Roof</option>
                    <option value="hip">Hip Roof</option>
                    <option value="flat">Flat Roof</option>
                    <option value="mansard">Mansard Roof</option>
                </select>
            </div>

            <div class="form-group">
                <label for="roof-height">Roof Height (m):</label>
                <input type="number" id="roof-height" min="0.5" max="10" value="2.5" step="0.1">
            </div>

            <div class="form-group">
                <label for="house-style">Architectural Style:</label>
                <select id="house-style">
                    <option value="modern">Modern</option>
                    <option value="traditional">Traditional</option>
                    <option value="colonial">Colonial</option>
                    <option value="cottage">Cottage</option>
                </select>
            </div>
        </div>
        
        <div id="rooms" class="tab-content">
            <div id="rooms-container"></div>
            <button class="add-btn" onclick="addRoom()">
                <i class="fas fa-plus"></i> Add Room
            </button>
        </div>
        
        <div id="features" class="tab-content">
            <h3>Exterior Features</h3>
            <div class="form-group">
                <label for="main-entrance">Main Entrance Side:</label>
                <select id="main-entrance">
                    <option value="north">North</option>
                    <option value="south">South</option>
                    <option value="east">East</option>
                    <option value="west">West</option>
                </select>
            </div>

            <h4>Windows</h4>
            <div id="windows-container"></div>
            <button class="add-btn" onclick="addWindow()">
                <i class="fas fa-plus"></i> Add Window
            </button>

            <h4>Doors</h4>
            <div id="doors-container"></div>
            <button class="add-btn" onclick="addDoor()">
                <i class="fas fa-plus"></i> Add Door
            </button>

            <h4>Additional Features</h4>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="has-chimney"> Include Chimney
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="has-porch"> Include Front Porch
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="has-garage"> Include Garage
                </label>
            </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <button id="generate-btn" onclick="generateHouse()">
                <i class="fas fa-sync-alt"></i> Generate 3D House
            </button>
            <button id="save-btn" onclick="saveDesign()" style="margin-top: 10px; background-color: #4CAF50;">
                <i class="fas fa-save"></i> Save Design
            </button>
            <button id="load-btn" onclick="loadDesign()" style="margin-top: 10px; background-color: #2196F3;">
                <i class="fas fa-folder-open"></i> Load Design
            </button>
        </div>
    </div>
    <div id="3d-view">
        <div class="controls">
            <div>Left-click + drag: Rotate</div>
            <div>Right-click + drag: Pan</div>
            <div>Scroll: Zoom</div>
        </div>
        <div id="loading">
            <h3>Loading Textures and Models</h3>
            <progress value="0" max="100"></progress>
            <div id="status">Initializing...</div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/TextureLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/RGBELoader.js"></script>
<script>
// Global variables
let scene, camera, renderer, controls;
let houseObjects = [];
let currentDesign = {};
let textureLoader = new THREE.TextureLoader();
let envMap, brickTexture, woodTexture, roofTexture, floorTexture, wallTexture;
let loadingManager = new THREE.LoadingManager();
// Add this with your other global variables at the top
const fallbackMaterials = {
    brick: new THREE.MeshStandardMaterial({ 
        color: 0xC0A080,
        roughness: 0.7,
        metalness: 0.1
    }),
    wood: new THREE.MeshStandardMaterial({ 
        color: 0x8B4513,
        roughness: 0.6,
        metalness: 0.2
    }),
    wall: new THREE.MeshStandardMaterial({ 
        color: 0xF5F5DC,
        roughness: 0.5,
        metalness: 0.0
    }),
    floor: new THREE.MeshStandardMaterial({ 
        color: 0xE6D5B8,
        roughness: 0.4,
        metalness: 0.0
    }),
    tile: new THREE.MeshStandardMaterial({
        color: 0xE0FFFF,
        roughness: 0.3,
        metalness: 0.1
    }),
    roof: new THREE.MeshStandardMaterial({
        color: 0x8B4513,
        roughness: 0.8,
        metalness: 0.1
    })
};

function getMaterial(type, texture = null, normalMap = null, roughnessMap = null) {
    const material = fallbackMaterials[type] || fallbackMaterials.wall;
    
    if (texture) {
        material.map = texture;
        material.needsUpdate = true;
    }
    if (normalMap) {
        material.normalMap = normalMap;
        material.needsUpdate = true;
    }
    if (roughnessMap) {
        material.roughnessMap = roughnessMap;
        material.needsUpdate = true;
    }
    
    return material.clone(); // Return a clone so we don't modify the original
}
// Show loading progress
loadingManager.onProgress = function (url, itemsLoaded, itemsTotal) {
    const progress = Math.round((itemsLoaded / itemsTotal) * 100);
    document.querySelector('progress').value = progress;
    document.getElementById('status').textContent = `Loading ${url} (${itemsLoaded}/${itemsTotal})`;
};

// Initialize Three.js scene
async function init() {
    document.getElementById('loading').style.display = 'block';
    
    // Create scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    
    // Load environment map for realistic reflections
    await loadEnvironmentMap();
    
    // Load textures
    await loadTextures();
    
    // Setup lighting
    setupLighting();
    
    // Create camera
    camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 350) / window.innerHeight, 0.1, 1000);
    camera.position.set(15, 15, 15);
    
    // Create renderer with physically correct lighting
    renderer = new THREE.WebGLRenderer({ 
        antialias: true,
        powerPreference: "high-performance"
    });
    renderer.setSize(window.innerWidth - 350, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1;
    renderer.outputEncoding = THREE.sRGBEncoding;
    document.getElementById('3d-view').appendChild(renderer.domElement);
    
    // Add orbit controls
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    // Add ground plane
    createGroundPlane();
    
    // Handle window resize
    window.addEventListener('resize', onWindowResize);
    
    // Start animation loop
    animate();
    
    document.getElementById('loading').style.display = 'none';
}

// Load environment map
async function loadEnvironmentMap() {
    return new Promise((resolve) => {
        try {
            new THREE.RGBELoader()
                .setDataType(THREE.UnsignedByteType)
                .load(
                    'https://threejs.org/examples/textures/equirectangular/venice_sunset_1k.hdr',
                    (texture) => {
                        envMap = texture;
                        envMap.mapping = THREE.EquirectangularReflectionMapping;
                        resolve();
                    },
                    undefined,
                    (error) => {
                        console.error('Error loading environment map:', error);
                        scene.background = new THREE.Color(0x87CEEB); // Fallback sky color
                        resolve();
                    }
                );
        } catch (e) {
            console.error('Environment map loader error:', e);
            scene.background = new THREE.Color(0x87CEEB);
            resolve();
        }
    });
}

// Load all textures
async function loadTextures() {
    return new Promise((resolve) => {
        const textures = {
            // Updated working texture paths from Three.js examples
            brick: 'https://threejs.org/examples/textures/brick/brick_diffuse.jpg',
            brickNormal: 'https://threejs.org/examples/textures/brick/brick_normal.jpg',
            brickRoughness: 'https://threejs.org/examples/textures/brick/brick_roughness.jpg',
            wood: 'https://threejs.org/examples/textures/wood/wood_diffuse.jpg',
            woodNormal: 'https://threejs.org/examples/textures/wood/wood_normal.jpg',
            roof: 'https://threejs.org/examples/textures/hardwood/hardwood_diffuse.jpg',
            floor: 'https://threejs.org/examples/textures/terracotta/terracotta_diffuse.jpg',
            wall: 'https://threejs.org/examples/textures/plaster/plaster_diffuse.jpg',
            tiles: 'https://threejs.org/examples/textures/tiles/tiles_diffuse.jpg'
        };

        let loaded = 0;
        const total = Object.keys(textures).length;

        const onLoad = () => {
            loaded++;
            if (loaded === total) {
                console.log('All textures loaded successfully');
                resolve();
            }
        };

        // Load brick texture
        brickTexture = textureLoader.load(
            textures.brick,
            (tex) => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                onLoad();
            },
            undefined,
            (err) => {
                console.warn('Brick texture failed to load:', err);
                brickTexture = null;
                onLoad();
            }
        );

        // Load brick normal map
        brickNormalMap = textureLoader.load(
            textures.brickNormal,
            (tex) => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                onLoad();
            },
            undefined,
            (err) => {
                console.warn('Brick normal map failed to load:', err);
                brickNormalMap = null;
                onLoad();
            }
        );

        // Load brick roughness map
        brickRoughnessMap = textureLoader.load(
            textures.brickRoughness,
            (tex) => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                onLoad();
            },
            undefined,
            (err) => {
                console.warn('Brick roughness map failed to load:', err);
                brickRoughnessMap = null;
                onLoad();
            }
        );

        // Load wood texture
        woodTexture = textureLoader.load(
            textures.wood,
            (tex) => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                onLoad();
            },
            undefined,
            (err) => {
                console.warn('Wood texture failed to load:', err);
                woodTexture = null;
                onLoad();
            }
        );

        // Load wood normal map
        woodNormalMap = textureLoader.load(
            textures.woodNormal,
            (tex) => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                onLoad();
            },
            undefined,
            (err) => {
                console.warn('Wood normal map failed to load:', err);
                woodNormalMap = null;
                onLoad();
            }
        );

        // Load roof texture
        roofTexture = textureLoader.load(
            textures.roof,
            (tex) => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                onLoad();
            },
            undefined,
            (err) => {
                console.warn('Roof texture failed to load:', err);
                roofTexture = null;
                onLoad();
            }
        );

        // Load floor texture
        floorTexture = textureLoader.load(
            textures.floor,
            (tex) => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                onLoad();
            },
            undefined,
            (err) => {
                console.warn('Floor texture failed to load:', err);
                floorTexture = null;
                onLoad();
            }
        );

        // Load wall texture
        wallTexture = textureLoader.load(
            textures.wall,
            (tex) => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                onLoad();
            },
            undefined,
            (err) => {
                console.warn('Wall texture failed to load:', err);
                wallTexture = null;
                onLoad();
            }
        );

        // Load tiles texture
        tilesTexture = textureLoader.load(
            textures.tiles,
            (tex) => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                onLoad();
            },
            undefined,
            (err) => {
                console.warn('Tiles texture failed to load:', err);
                tilesTexture = null;
                onLoad();
            }
        );
    });
}

// Setup realistic lighting
function setupLighting() {
    // Add ambient light
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    
    // Add directional light (sun)
    const sunLight = new THREE.DirectionalLight(0xffffff, 1);
    sunLight.position.set(10, 20, 10);
    sunLight.castShadow = true;
    sunLight.shadow.mapSize.width = 2048;
    sunLight.shadow.mapSize.height = 2048;
    sunLight.shadow.camera.near = 0.5;
    sunLight.shadow.camera.far = 500;
    sunLight.shadow.camera.left = -50;
    sunLight.shadow.camera.right = 50;
    sunLight.shadow.camera.top = 50;
    sunLight.shadow.camera.bottom = -50;
    scene.add(sunLight);
    
    // Add hemisphere light for more natural lighting
    const hemisphereLight = new THREE.HemisphereLight(0xffffbb, 0x080820, 0.6);
    scene.add(hemisphereLight);
    
    // Add fill light
    const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
    fillLight.position.set(-10, 10, -10);
    scene.add(fillLight);
}

// Create ground plane
function createGroundPlane() {
    const groundGeometry = new THREE.PlaneGeometry(100, 100);
    const groundMaterial = new THREE.MeshStandardMaterial({
        color: 0x8B8B83,
        roughness: 0.8,
        metalness: 0.2
    });
    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);
    houseObjects.push(ground);
}

// Animation loop
function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

// Handle window resize
function onWindowResize() {
    const width = window.innerWidth - 350;
    const height = window.innerHeight;
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
}

// Tab navigation
function openTab(tabName) {
    const tabs = document.getElementsByClassName('tab');
    const tabContents = document.getElementsByClassName('tab-content');
    
    for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
        tabContents[i].classList.remove('active');
    }
    
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');
}

// Add room UI
function addRoom() {
    const roomId = Date.now();
    const html = `
    <div class="section" id="room-${roomId}">
        <div class="form-group">
            <label for="room-type-${roomId}">Room Type:</label>
            <select id="room-type-${roomId}" class="room-type">
                <option value="living">Living Room</option>
                <option value="bedroom">Bedroom</option>
                <option value="kitchen">Kitchen</option>
                <option value="bathroom">Bathroom</option>
                <option value="dining">Dining Room</option>
                <option value="office">Home Office</option>
                <option value="garage">Garage</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="room-width-${roomId}">Width (m):</label>
            <input type="number" id="room-width-${roomId}" min="2" max="20" value="4" step="0.1">
        </div>
        
        <div class="form-group">
            <label for="room-depth-${roomId}">Depth (m):</label>
            <input type="number" id="room-depth-${roomId}" min="2" max="20" value="4" step="0.1">
        </div>
        
        <div class="form-group">
            <label for="room-x-${roomId}">X Position (m):</label>
            <input type="number" id="room-x-${roomId}" min="-20" max="20" value="0" step="0.1">
        </div>
        
        <div class="form-group">
            <label for="room-z-${roomId}">Z Position (m):</label>
            <input type="number" id="room-z-${roomId}" min="-20" max="20" value="0" step="0.1">
        </div>
        
        <button class="remove-btn" onclick="document.getElementById('room-${roomId}').remove()">
            <i class="fas fa-trash"></i> Remove Room
        </button>
    </div>`;
    
    document.getElementById('rooms-container').insertAdjacentHTML('beforeend', html);
}

// Add window UI
function addWindow() {
    const windowId = Date.now();
    const html = `
    <div class="feature-item" id="window-${windowId}">
        <div style="flex-grow: 1;">
            <div class="form-group" style="margin-bottom: 5px;">
                <select id="window-wall-${windowId}" style="width: auto;">
                    <option value="north">North Wall</option>
                    <option value="south">South Wall</option>
                    <option value="east">East Wall</option>
                    <option value="west">West Wall</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px;">Width</label>
                    <input type="number" id="window-width-${windowId}" min="0.5" max="5" value="1.2" step="0.1" style="width: 60px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px;">Height</label>
                    <input type="number" id="window-height-${windowId}" min="0.5" max="3" value="1.2" step="0.1" style="width: 60px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px;">Position</label>
                    <input type="number" id="window-pos-${windowId}" min="0" max="20" value="1.5" step="0.1" style="width: 60px;">
                </div>
            </div>
        </div>
        <button class="remove-btn" onclick="document.getElementById('window-${windowId}').remove()">
            <i class="fas fa-times"></i>
        </button>
    </div>`;
    
    document.getElementById('windows-container').insertAdjacentHTML('beforeend', html);
}

// Add door UI
function addDoor() {
    const doorId = Date.now();
    const html = `
    <div class="feature-item" id="door-${doorId}">
        <div style="flex-grow: 1;">
            <div class="form-group" style="margin-bottom: 5px;">
                <select id="door-wall-${doorId}" style="width: auto;">
                    <option value="north">North Wall</option>
                    <option value="south">South Wall</option>
                    <option value="east">East Wall</option>
                    <option value="west">West Wall</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px;">Width</label>
                    <input type="number" id="door-width-${doorId}" min="0.5" max="2" value="0.9" step="0.1" style="width: 60px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px;">Height</label>
                    <input type="number" id="door-height-${doorId}" min="1.5" max="3" value="2.1" step="0.1" style="width: 60px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px;">Position</label>
                    <input type="number" id="door-pos-${doorId}" min="0" max="20" value="0" step="0.1" style="width: 60px;">
                </div>
            </div>
        </div>
        <button class="remove-btn" onclick="document.getElementById('door-${doorId}').remove()">
            <i class="fas fa-times"></i>
        </button>
    </div>`;
    
    document.getElementById('doors-container').insertAdjacentHTML('beforeend', html);
}

// Generate the 3D house based on form inputs
function generateHouse() {
    // Clear previous objects
    houseObjects.forEach(obj => {
        if (obj && obj.parent) { // Check if object exists and has parent
            scene.remove(obj);
        }
    });
    houseObjects = [];
    
    // Get dimensions
    const width = parseFloat(document.getElementById('house-width').value);
    const depth = parseFloat(document.getElementById('house-depth').value);
    const height = parseFloat(document.getElementById('house-height').value);
    const roofType = document.getElementById('roof-type').value;
    const roofHeight = parseFloat(document.getElementById('roof-height').value);
    const entrance = document.getElementById('main-entrance').value;
    const style = document.getElementById('house-style').value;
    
    // Create foundation
    const foundation = createFoundation(width, depth, style);
    scene.add(foundation);
    houseObjects.push(foundation);
    
    // Create only exterior walls
    createExteriorWalls(width, depth, height, style);
    
    // Create main entrance door
    createMainDoor(entrance, width, depth, height, style);
    
    // Create windows
    createWindows(width, depth, height, style);
    
    // Create open rooms (no interior walls)
    createOpenRooms(height, style);
    
    // Create roof
    createRoof(roofType, width, depth, height, roofHeight, style);
    
    // Create additional features
    if (document.getElementById('has-chimney').checked) {
        createChimney(width, depth, height + roofHeight, style);
    }
    if (document.getElementById('has-porch').checked) {
        createPorch(entrance, width, depth, height, style);
    }
    if (document.getElementById('has-garage').checked) {
        createGarage(width, depth, height, style);
    }
    
    // Position camera to view the whole house
    const maxDimension = Math.max(width, depth, height + roofHeight);
    camera.position.set(maxDimension * 1.5, maxDimension * 1.5, maxDimension * 1.5);
    controls.target.set(0, height/2, 0);
    controls.update();
    
    // Save current design
    saveCurrentDesign();
}

function createOpenRooms(houseHeight, style) {
    document.querySelectorAll('[id^="room-type-"]').forEach(el => {
        const id = el.id.split('-')[2];
        const type = document.getElementById(`room-type-${id}`).value;
        const width = parseFloat(document.getElementById(`room-width-${id}`).value);
        const depth = parseFloat(document.getElementById(`room-depth-${id}`).value);
        const x = parseFloat(document.getElementById(`room-x-${id}`).value);
        const z = parseFloat(document.getElementById(`room-z-${id}`).value);
        
        // Create only the floor
        const floor = createFloor(type, width, depth, x, z, style);
        scene.add(floor);
        houseObjects.push(floor);
        
        // Add room visualization (optional)
        createRoomVisualization(x, z, width, depth, houseHeight, type);
    });
}

function createRoomVisualization(centerX, centerZ, width, depth, height, roomType) {
    // Create semi-transparent room volume
    const roomGeometry = new THREE.BoxGeometry(width, height, depth);
    const roomMaterial = new THREE.MeshBasicMaterial({
        color: getRoomColor(roomType),
        transparent: true,
        opacity: 0.1,
        side: THREE.DoubleSide
    });
    const roomVolume = new THREE.Mesh(roomGeometry, roomMaterial);
    roomVolume.position.set(centerX, height/2, centerZ);
    scene.add(roomVolume);
    houseObjects.push(roomVolume);
    
    // Create floor border
    const borderGeometry = new THREE.EdgesGeometry(new THREE.BoxGeometry(width, 0.01, depth));
    const borderMaterial = new THREE.LineBasicMaterial({
        color: 0x00ff00,
        linewidth: 2
    });
    const border = new THREE.LineSegments(borderGeometry, borderMaterial);
    border.position.set(centerX, 0.02, centerZ);
    scene.add(border);
    houseObjects.push(border);
    
    // Add room label
    addRoomLabel(roomType, centerX, height + 0.5, centerZ);
}

function createExteriorWalls(width, depth, height, style) {
    const wallThickness = 0.3;
    
    // Only create outer walls
    createWall(0, height/2, -depth/2, width, height, wallThickness, 0, style); // North
    createWall(0, height/2, depth/2, width, height, wallThickness, 0, style);  // South
    createWall(-width/2, height/2, 0, wallThickness, height, depth, Math.PI/2, style); // West
    createWall(width/2, height/2, 0, wallThickness, height, depth, Math.PI/2, style);  // East
}
// Create foundation
function createFoundation(width, depth, style) {
    const foundationGeometry = new THREE.BoxGeometry(width, 0.3, depth);
    
    let foundationMaterial;
    if (style === 'modern') {
        foundationMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x333333,
            roughness: 0.7,
            metalness: 0.3
        });
    } else {
        foundationMaterial = new THREE.MeshStandardMaterial({ 
            map: brickTexture,
            normalMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/brick_normal.jpg'),
            roughnessMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/brick_roughness.jpg'),
            roughness: 0.8,
            metalness: 0.2
        });
        foundationMaterial.map.repeat.set(width / 2, depth / 2);
        foundationMaterial.normalMap.repeat.set(width / 2, depth / 2);
        foundationMaterial.roughnessMap.repeat.set(width / 2, depth / 2);
        foundationMaterial.map.needsUpdate = true;
        foundationMaterial.normalMap.needsUpdate = true;
        foundationMaterial.roughnessMap.needsUpdate = true;
    }
    
    const foundation = new THREE.Mesh(foundationGeometry, foundationMaterial);
    foundation.position.y = -0.15;
    foundation.receiveShadow = true;
    foundation.castShadow = true;
    scene.add(foundation);
    return foundation;
}

// Create exterior walls
function createExteriorWalls(width, depth, height, style) {
    const wallThickness = 0.3;
    
    // North wall
    const northWall = createWall(0, height/2, -depth/2, width, height, wallThickness, 0, style);
    northWall.castShadow = true;
    
    // South wall
    const southWall = createWall(0, height/2, depth/2, width, height, wallThickness, 0, style);
    southWall.castShadow = true;
    
    // West wall
    const westWall = createWall(-width/2, height/2, 0, wallThickness, height, depth, Math.PI/2, style);
    westWall.castShadow = true;
    
    // East wall
    const eastWall = createWall(width/2, height/2, 0, wallThickness, height, depth, Math.PI/2, style);
    eastWall.castShadow = true;
}

// Create a wall segment with realistic materials
function createWall(x, y, z, width, height, depth, rotationY, style) {
    const wallGeometry = new THREE.BoxGeometry(width, height, depth);
    
    let wallMaterial;
    if (style === 'modern') {
        wallMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xFFFFFF,
            roughness: 0.4,
            metalness: 0.1,
            envMap: envMap,
            envMapIntensity: 0.2
        });
    } else if (style === 'traditional') {
        wallMaterial = new THREE.MeshStandardMaterial({ 
            map: brickTexture,
            normalMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/brick_normal.jpg'),
            roughnessMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/brick_roughness.jpg'),
            roughness: 0.7,
            metalness: 0.1,
            envMap: envMap,
            envMapIntensity: 0.1
        });
        wallMaterial.map.repeat.set(width / 1.5, height / 1.5);
        wallMaterial.normalMap.repeat.set(width / 1.5, height / 1.5);
        wallMaterial.roughnessMap.repeat.set(width / 1.5, height / 1.5);
        wallMaterial.map.needsUpdate = true;
        wallMaterial.normalMap.needsUpdate = true;
        wallMaterial.roughnessMap.needsUpdate = true;
    } else if (style === 'colonial') {
        wallMaterial = new THREE.MeshStandardMaterial({ 
            map: wallTexture,
            color: 0xF5F5DC,
            roughness: 0.6,
            metalness: 0.0,
            envMap: envMap,
            envMapIntensity: 0.1
        });
        wallMaterial.map.repeat.set(width / 2, height / 2);
        wallMaterial.map.needsUpdate = true;
    } else { // cottage
        wallMaterial = new THREE.MeshStandardMaterial({ 
            map: woodTexture,
            normalMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/wood_normal.jpg'),
            roughness: 0.8,
            metalness: 0.0,
            envMap: envMap,
            envMapIntensity: 0.1
        });
        wallMaterial.map.repeat.set(width / 2, height / 2);
        wallMaterial.normalMap.repeat.set(width / 2, height / 2);
        wallMaterial.map.needsUpdate = true;
        wallMaterial.normalMap.needsUpdate = true;
    }
    
    const wall = new THREE.Mesh(wallGeometry, wallMaterial);
    wall.position.set(x, y, z);
    wall.rotation.y = rotationY;
    wall.receiveShadow = true;
    wall.castShadow = true;
    scene.add(wall);
    houseObjects.push(wall);
    return wall;
}

// Create main entrance door with realistic model
function createMainDoor(side, width, depth, height, style) {
    const doorWidth = 1.2;
    const doorHeight = 2.2;
    const doorThickness = 0.1;
    
    let doorMaterial;
    if (style === 'modern') {
        doorMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x333333,
            roughness: 0.3,
            metalness: 0.8,
            envMap: envMap,
            envMapIntensity: 0.5
        });
    } else {
        doorMaterial = new THREE.MeshStandardMaterial({ 
            map: woodTexture,
            normalMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/wood_normal.jpg'),
            roughness: 0.6,
            metalness: 0.1,
            envMap: envMap,
            envMapIntensity: 0.2
        });
        doorMaterial.map.repeat.set(2, 4);
        doorMaterial.normalMap.repeat.set(2, 4);
        doorMaterial.map.needsUpdate = true;
        doorMaterial.normalMap.needsUpdate = true;
    }
    
    // Create door frame
    const frameGeometry = new THREE.BoxGeometry(doorWidth + 0.2, doorHeight + 0.2, doorThickness);
    const frameMaterial = new THREE.MeshStandardMaterial({ 
        color: style === 'modern' ? 0x333333 : 0x8B4513,
        roughness: 0.5,
        metalness: 0.3
    });
    const frame = new THREE.Mesh(frameGeometry, frameMaterial);
    
    // Create door panel
    const panelGeometry = new THREE.BoxGeometry(doorWidth - 0.1, doorHeight - 0.1, doorThickness);
    const panel = new THREE.Mesh(panelGeometry, doorMaterial);
    panel.position.z = -0.05;
    
    const doorGroup = new THREE.Group();
    doorGroup.add(frame);
    doorGroup.add(panel);
    
    const offset = doorThickness / 2;
    let x = 0, z = 0, ry = 0;
    
    if (side === 'north') { 
        z = -depth/2 + offset; 
        ry = Math.PI;
    }
    if (side === 'south') { 
        z = depth/2 - offset; 
    }
    if (side === 'east') { 
        x = width/2 - offset; 
        z = 0; 
        ry = Math.PI/2; 
    }
    if (side === 'west') { 
        x = -width/2 + offset; 
        z = 0; 
        ry = -Math.PI/2; 
    }
    
    doorGroup.position.set(x, doorHeight/2, z);
    doorGroup.rotation.y = ry;
    doorGroup.castShadow = true;
    scene.add(doorGroup);
    houseObjects.push(doorGroup);
    
    return doorGroup;
}

// Create windows with realistic glass and frames
function createWindows(houseWidth, houseDepth, houseHeight, style) {
    document.querySelectorAll('[id^="window-wall-"]').forEach(el => {
        const id = el.id.split('-')[2];
        const wall = document.getElementById(`window-wall-${id}`).value;
        const width = parseFloat(document.getElementById(`window-width-${id}`).value);
        const height = parseFloat(document.getElementById(`window-height-${id}`).value);
        const position = parseFloat(document.getElementById(`window-pos-${id}`).value);
        
        // Create window frame
        const frameThickness = 0.1;
        const frameGeometry = new THREE.BoxGeometry(width + 0.1, height + 0.1, frameThickness);
        const frameMaterial = new THREE.MeshStandardMaterial({ 
            color: style === 'modern' ? 0x333333 : 0x8B4513,
            roughness: 0.5,
            metalness: 0.3
        });
        const frame = new THREE.Mesh(frameGeometry, frameMaterial);
        
        // Create window glass with realistic properties
        const glassGeometry = new THREE.BoxGeometry(width - 0.05, height - 0.05, 0.01);
        const glassMaterial = new THREE.MeshPhysicalMaterial({
            color: 0xffffff,
            transmission: 0.9,
            roughness: 0.05,
            metalness: 0.0,
            clearcoat: 1.0,
            clearcoatRoughness: 0.05,
            ior: 1.52,
            thickness: 0.01,
            envMap: envMap,
            envMapIntensity: 1.0
        });
        const glass = new THREE.Mesh(glassGeometry, glassMaterial);
        
        // Create window sill
        const sillGeometry = new THREE.BoxGeometry(width + 0.2, 0.05, 0.2);
        const sillMaterial = new THREE.MeshStandardMaterial({ 
            color: style === 'modern' ? 0x333333 : 0x8B4513,
            roughness: 0.6,
            metalness: 0.2
        });
        const sill = new THREE.Mesh(sillGeometry, sillMaterial);
        sill.position.y = -height/2 - 0.025;
        sill.position.z = -0.1;
        
        const windowGroup = new THREE.Group();
        windowGroup.add(frame);
        windowGroup.add(glass);
        windowGroup.add(sill);
        
        let x = 0, z = 0, ry = 0;
        const offset = 0.15;
        
        if (wall === 'north') { 
            x = position; 
            z = -houseDepth/2 + offset; 
            ry = Math.PI; 
        }
        if (wall === 'south') { 
            x = position; 
            z = houseDepth/2 - offset; 
        }
        if (wall === 'east') { 
            x = houseWidth/2 - offset; 
            z = position; 
            ry = Math.PI/2; 
        }
        if (wall === 'west') { 
            x = -houseWidth/2 + offset; 
            z = position; 
            ry = -Math.PI/2; 
        }
        
        windowGroup.position.set(x, height/2 + 0.8, z);
        windowGroup.rotation.y = ry;
        windowGroup.castShadow = true;
        scene.add(windowGroup);
        houseObjects.push(windowGroup);
    });
}

// Create additional doors
function createDoors(houseWidth, houseDepth, houseHeight, style) {
    document.querySelectorAll('[id^="door-wall-"]').forEach(el => {
        const id = el.id.split('-')[2];
        const wall = document.getElementById(`door-wall-${id}`).value;
        const width = parseFloat(document.getElementById(`door-width-${id}`).value);
        const height = parseFloat(document.getElementById(`door-height-${id}`).value);
        const position = parseFloat(document.getElementById(`door-pos-${id}`).value);
        
        const doorThickness = 0.1;
        
        let doorMaterial;
        if (style === 'modern') {
            doorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x333333,
                roughness: 0.3,
                metalness: 0.8,
                envMap: envMap,
                envMapIntensity: 0.5
            });
        } else {
            doorMaterial = new THREE.MeshStandardMaterial({ 
                map: woodTexture,
                normalMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/wood_normal.jpg'),
                roughness: 0.6,
                metalness: 0.1,
                envMap: envMap,
                envMapIntensity: 0.2
            });
            doorMaterial.map.repeat.set(2, 4);
            doorMaterial.normalMap.repeat.set(2, 4);
            doorMaterial.map.needsUpdate = true;
            doorMaterial.normalMap.needsUpdate = true;
        }
        
        // Create door frame
        const frameGeometry = new THREE.BoxGeometry(width + 0.2, height + 0.2, doorThickness);
        const frameMaterial = new THREE.MeshStandardMaterial({ 
            color: style === 'modern' ? 0x333333 : 0x8B4513,
            roughness: 0.5,
            metalness: 0.3
        });
        const frame = new THREE.Mesh(frameGeometry, frameMaterial);
        
        // Create door panel
        const panelGeometry = new THREE.BoxGeometry(width - 0.1, height - 0.1, doorThickness);
        const panel = new THREE.Mesh(panelGeometry, doorMaterial);
        panel.position.z = -0.05;
        
        const doorGroup = new THREE.Group();
        doorGroup.add(frame);
        doorGroup.add(panel);
        
        const offset = doorThickness / 2;
        let x = 0, z = 0, ry = 0;
        
        if (wall === 'north') { 
            x = position; 
            z = -houseDepth/2 + offset; 
            ry = Math.PI; 
        }
        if (wall === 'south') { 
            x = position; 
            z = houseDepth/2 - offset; 
        }
        if (wall === 'east') { 
            x = houseWidth/2 - offset; 
            z = position; 
            ry = Math.PI/2; 
        }
        if (wall === 'west') { 
            x = -houseWidth/2 + offset; 
            z = position; 
            ry = -Math.PI/2; 
        }
        
        doorGroup.position.set(x, height/2, z);
        doorGroup.rotation.y = ry;
        doorGroup.castShadow = true;
        scene.add(doorGroup);
        houseObjects.push(doorGroup);
    });
}

// Create roof with realistic materials
function createRoof(type, width, depth, height, roofHeight, style) {
    let roof;
    const roofMaterial = new THREE.MeshStandardMaterial({ 
        color: style === 'modern' ? 0x333333 : 0x8B4513,
        roughness: 0.7,
        metalness: 0.1
    });

    if (type === 'flat') {
        const roofGeometry = new THREE.BoxGeometry(width + 0.5, 0.2, depth + 0.5);
        roof = new THREE.Mesh(roofGeometry, roofMaterial);
        roof.position.y = height + 0.1;
    } 
    else if (type === 'gable') {
        const shape = new THREE.Shape();
        shape.moveTo(-width/2, 0); 
        shape.lineTo(0, roofHeight); 
        shape.lineTo(width/2, 0);
        
        const extrudeSettings = { 
            depth: depth, 
            bevelEnabled: false,
            steps: 1
        };
        
        const roofGeometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
        roof = new THREE.Mesh(roofGeometry, roofMaterial);
        roof.rotateX(Math.PI/2);
        roof.translate(0, height, -depth/2);
        
        // Proper UV initialization
        roofGeometry.computeBoundingBox();
        roofGeometry.computeVertexNormals();
        roofGeometry.uvsNeedUpdate = true;
    }
    else if (type === 'hip') {
        const roofGeometry = new THREE.ConeGeometry(
            Math.sqrt(width*width + depth*depth)/2, 
            roofHeight, 
            4
        );
        roof = new THREE.Mesh(roofGeometry, roofMaterial);
        roof.position.y = height + roofHeight/2;
        roof.rotateY(Math.PI/4);
    }
    else if (type === 'mansard') {
        const shape = new THREE.Shape();
        const overhang = 0.5;
        const slopeHeight = roofHeight * 0.7;
        
        shape.moveTo(-width/2 - overhang, 0);
        shape.lineTo(-width/2, slopeHeight);
        shape.lineTo(-width/4, roofHeight);
        shape.lineTo(width/4, roofHeight);
        shape.lineTo(width/2, slopeHeight);
        shape.lineTo(width/2 + overhang, 0);
        
        const extrudeSettings = { 
            depth: depth + overhang*2, 
            bevelEnabled: false,
            steps: 1
        };
        
        const roofGeometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
        roof = new THREE.Mesh(roofGeometry, roofMaterial);
        roof.rotateX(Math.PI/2);
        roof.translate(0, height, -depth/2 - overhang);
        
        // Proper UV initialization
        roofGeometry.computeBoundingBox();
        roofGeometry.computeVertexNormals();
        roofGeometry.uvsNeedUpdate = true;
    }
    
    if (roof) {
        roof.castShadow = true;
        roof.receiveShadow = true;
        scene.add(roof);
        houseObjects.push(roof);
    }
    return roof;
}

// Create interior rooms with realistic flooring
function createRooms(houseHeight) {
    document.querySelectorAll('[id^="room-type-"]').forEach(el => {
        const id = el.id.split('-')[2];
        const width = parseFloat(document.getElementById(`room-width-${id}`).value);
        const depth = parseFloat(document.getElementById(`room-depth-${id}`).value);
        const x = parseFloat(document.getElementById(`room-x-${id}`).value);
        const z = parseFloat(document.getElementById(`room-z-${id}`).value);
        
        // Create just the floor
        const floor = createFloor(type, width, depth, x, z);
        scene.add(floor);
        houseObjects.push(floor);
    });
}

function createFloor(type, width, depth, x, z) {
    let floorMaterial;
    
    if (type === 'bathroom') {
        floorMaterial = getMaterial('tile', 
            textureLoader.load('https://threejs.org/examples/textures/tiles/tiles_diffuse.jpg'),
            textureLoader.load('https://threejs.org/examples/textures/tiles/tiles_normal.jpg')
        );
        if (floorMaterial.map) {
            floorMaterial.map.repeat.set(width / 0.5, depth / 0.5);
            floorMaterial.map.needsUpdate = true;
        }
    } 
    else if (type === 'kitchen') {
        floorMaterial = getMaterial('wood', 
            textureLoader.load('https://threejs.org/examples/textures/wood/wood_diffuse.jpg'),
            textureLoader.load('https://threejs.org/examples/textures/wood/wood_normal.jpg')
        );
        if (floorMaterial.map) {
            floorMaterial.map.repeat.set(width / 1.5, depth / 1.5);
            floorMaterial.map.needsUpdate = true;
        }
    } 
    else {
        floorMaterial = getMaterial('floor');
    }

    const floor = new THREE.Mesh(
        new THREE.BoxGeometry(width, 0.1, depth),
        floorMaterial
    );
    floor.position.set(x, 0, z);
    floor.receiveShadow = true;
    return floor;
}
// Create interior wall with realistic materials
function createInteriorWall(x, y, z, width, height, depth, rotationY, roomType) {
    const wallGeometry = new THREE.BoxGeometry(width, height, depth);
    
    let wallMaterial;
    if (roomType === 'bathroom') {
        wallMaterial = getMaterial('tile', 
            textureLoader.load('https://threejs.org/examples/textures/tiles/tiles_diffuse.jpg'),
            textureLoader.load('https://threejs.org/examples/textures/tiles/tiles_normal.jpg')
        );
        if (wallMaterial.map) {
            wallMaterial.map.repeat.set(width / 0.5, height / 0.5);
            wallMaterial.map.needsUpdate = true;
        }
    } else {
        wallMaterial = getMaterial('wall');
    }

    const wall = new THREE.Mesh(wallGeometry, wallMaterial);
    wall.position.set(x, y, z);
    wall.rotation.y = rotationY;
    wall.receiveShadow = true;
    wall.castShadow = true;
    scene.add(wall);
    houseObjects.push(wall);
    return wall;
}

// Create chimney
function createChimney(houseWidth, houseDepth, height, style) {
    const chimneyWidth = 0.8;
    const chimneyDepth = 0.8;
    const chimneyHeight = 2.0;
    
    let chimneyMaterial;
    if (style === 'modern') {
        chimneyMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x333333,
            roughness: 0.4,
            metalness: 0.8,
            envMap: envMap,
            envMapIntensity: 0.3
        });
    } else {
        chimneyMaterial = new THREE.MeshStandardMaterial({ 
            map: brickTexture,
            normalMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/brick_normal.jpg'),
            roughnessMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/brick_roughness.jpg'),
            roughness: 0.7,
            metalness: 0.1
        });
        chimneyMaterial.map.repeat.set(2, 2);
        chimneyMaterial.normalMap.repeat.set(2, 2);
        chimneyMaterial.roughnessMap.repeat.set(2, 2);
        chimneyMaterial.map.needsUpdate = true;
        chimneyMaterial.normalMap.needsUpdate = true;
        chimneyMaterial.roughnessMap.needsUpdate = true;
    }
    
    const chimney = new THREE.Mesh(
        new THREE.BoxGeometry(chimneyWidth, chimneyHeight, chimneyDepth),
        chimneyMaterial
    );
    chimney.position.set(
        houseWidth/2 - chimneyWidth,
        height + chimneyHeight/2,
        houseDepth/2 - chimneyDepth
    );
    chimney.castShadow = true;
    scene.add(chimney);
    houseObjects.push(chimney);
    
    // Add smoke effect (simple version)
    const smokeGeometry = new THREE.ConeGeometry(0.4, 1, 8);
    const smokeMaterial = new THREE.MeshBasicMaterial({ 
        color: 0xAAAAAA,
        transparent: true,
        opacity: 0.6
    });
    const smoke = new THREE.Mesh(smokeGeometry, smokeMaterial);
    smoke.position.set(
        houseWidth/2 - chimneyWidth,
        height + chimneyHeight + 0.5,
        houseDepth/2 - chimneyDepth
    );
    scene.add(smoke);
    houseObjects.push(smoke);
}

// Create porch
function createPorch(side, width, depth, height, style) {
    const porchDepth = 2.0;
    const porchHeight = 0.2;
    const porchWidth = width * 0.7;
    
    let porchMaterial;
    if (style === 'modern') {
        porchMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x333333,
            roughness: 0.5,
            metalness: 0.6
        });
    } else {
        porchMaterial = new THREE.MeshStandardMaterial({ 
            map: woodTexture,
            normalMap: textureLoader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/wood_normal.jpg'),
            roughness: 0.7,
            metalness: 0.0
        });
        porchMaterial.map.repeat.set(porchWidth / 2, porchDepth / 2);
        porchMaterial.normalMap.repeat.set(porchWidth / 2, porchDepth / 2);
        porchMaterial.map.needsUpdate = true;
        porchMaterial.normalMap.needsUpdate = true;
    }
    
    const porch = new THREE.Mesh(
        new THREE.BoxGeometry(porchWidth, porchHeight, porchDepth),
        porchMaterial
    );
    
    let x = 0, z = 0;
    if (side === 'north') z = -depth/2 - porchDepth/2;
    if (side === 'south') z = depth/2 + porchDepth/2;
    if (side === 'east') x = width/2 + porchDepth/2;
    if (side === 'west') x = -width/2 - porchDepth/2;
    
    porch.position.set(x, porchHeight/2, z);
    porch.receiveShadow = true;
    porch.castShadow = true;
    scene.add(porch);
    houseObjects.push(porch);
    
    // Add porch roof
    const porchRoof = new THREE.Mesh(
        new THREE.BoxGeometry(porchWidth + 0.5, 0.1, porchDepth + 0.5),
        new THREE.MeshStandardMaterial({ 
            color: style === 'modern' ? 0x333333 : 0x8B4513,
            roughness: 0.6,
            metalness: 0.2
        })
    );
    porchRoof.position.set(x, height - 0.5, z);
    porchRoof.receiveShadow = true;
    porchRoof.castShadow = true;
    scene.add(porchRoof);
    houseObjects.push(porchRoof);
    
    // Add support columns
    const columnGeometry = new THREE.CylinderGeometry(0.1, 0.1, height - porchHeight - 0.1, 8);
    const columnMaterial = new THREE.MeshStandardMaterial({ 
        color: style === 'modern' ? 0x333333 : 0x8B4513,
        roughness: 0.5,
        metalness: 0.3
    });
    
    const positions = [
        { x: porchWidth/2 - 0.5, z: porchDepth/2 - 0.5 },
        { x: -porchWidth/2 + 0.5, z: porchDepth/2 - 0.5 },
        { x: porchWidth/2 - 0.5, z: -porchDepth/2 + 0.5 },
        { x: -porchWidth/2 + 0.5, z: -porchDepth/2 + 0.5 }
    ];
    
    positions.forEach(pos => {
        const column = new THREE.Mesh(columnGeometry, columnMaterial);
        column.position.set(
            x + pos.x,
            (height - porchHeight)/2 + porchHeight,
            z + pos.z
        );
        column.castShadow = true;
        scene.add(column);
        houseObjects.push(column);
    });
}

// Create garage
function createGarage(houseWidth, houseDepth, houseHeight, style) {
    const garageWidth = 4.0;
    const garageDepth = 4.0;
    const garageHeight = houseHeight * 0.9;
    
    // Position garage on the side of the house
    const garageX = houseWidth/2 + garageWidth/2;
    const garageZ = 0;
    
    // Create garage foundation
    const foundation = new THREE.Mesh(
        new THREE.BoxGeometry(garageWidth, 0.3, garageDepth),
        new THREE.MeshStandardMaterial({ 
            color: 0x333333,
            roughness: 0.7,
            metalness: 0.3
        })
    );
    foundation.position.set(garageX, -0.15, garageZ);
    foundation.receiveShadow = true;
    scene.add(foundation);
    houseObjects.push(foundation);
    
    // Create garage walls
    const wallThickness = 0.3;
    const wallMaterial = new THREE.MeshStandardMaterial({ 
        color: style === 'modern' ? 0xFFFFFF : 0xF5E6C8,
        roughness: 0.6,
        metalness: 0.1
    });
    
    // Front wall (with garage door)
    const frontWall = new THREE.Mesh(
        new THREE.BoxGeometry(garageWidth, garageHeight, wallThickness),
        wallMaterial
    );
    frontWall.position.set(garageX, garageHeight/2, garageDepth/2);
    frontWall.castShadow = true;
    scene.add(frontWall);
    houseObjects.push(frontWall);
    
    // Create garage door opening
    const garageDoorWidth = 3.0;
    const garageDoorHeight = 2.5;
    
    const garageDoor = new THREE.Mesh(
        new THREE.BoxGeometry(garageDoorWidth, garageDoorHeight, 0.1),
        new THREE.MeshStandardMaterial({ 
            color: 0x333333,
            roughness: 0.4,
            metalness: 0.8,
            envMap: envMap,
            envMapIntensity: 0.5
        })
    );
    garageDoor.position.set(
        garageX,
        garageDoorHeight/2,
        garageDepth/2 + wallThickness/2 + 0.05
    );
    garageDoor.castShadow = true;
    scene.add(garageDoor);
    houseObjects.push(garageDoor);
    
    // Side walls
    const sideWall = new THREE.Mesh(
        new THREE.BoxGeometry(wallThickness, garageHeight, garageDepth),
        wallMaterial
    );
    sideWall.position.set(
        garageX - garageWidth/2 + wallThickness/2,
        garageHeight/2,
        garageZ
    );
    sideWall.castShadow = true;
    scene.add(sideWall);
    houseObjects.push(sideWall);
    
    // Back wall
    const backWall = new THREE.Mesh(
        new THREE.BoxGeometry(garageWidth, garageHeight, wallThickness),
        wallMaterial
    );
    backWall.position.set(garageX, garageHeight/2, -garageDepth/2);
    backWall.castShadow = true;
    scene.add(backWall);
    houseObjects.push(backWall);
    
    // Roof
    const garageRoof = new THREE.Mesh(
        new THREE.BoxGeometry(garageWidth + 0.5, 0.2, garageDepth + 0.5),
        new THREE.MeshStandardMaterial({ 
            color: style === 'modern' ? 0x333333 : 0x8B4513,
            roughness: 0.6,
            metalness: 0.2
        })
    );
    garageRoof.position.set(garageX, garageHeight + 0.1, garageZ);
    garageRoof.receiveShadow = true;
    garageRoof.castShadow = true;
    scene.add(garageRoof);
    houseObjects.push(garageRoof);
}

// Add room label
function addRoomLabel(type, x, y, z) {
    const canvas = document.createElement('canvas');
    canvas.width = 256;
    canvas.height = 128;
    const context = canvas.getContext('2d');
    
    context.fillStyle = 'rgba(0, 0, 0, 0.7)';
    context.fillRect(0, 0, canvas.width, canvas.height);
    
    context.font = 'Bold 40px Arial';
    context.fillStyle = 'white';
    context.textAlign = 'center';
    context.fillText(type.toUpperCase(), canvas.width/2, canvas.height/2 + 15);
    
    const texture = new THREE.CanvasTexture(canvas);
    const material = new THREE.SpriteMaterial({ map: texture });
    const sprite = new THREE.Sprite(material);
    sprite.position.set(x, y, z);
    sprite.scale.set(2, 1, 1);
    scene.add(sprite);
    houseObjects.push(sprite);
}

// Get room color based on type
function getRoomColor(type) {
    const colors = {
        living: 0xE6E6FA,  // Lavender
        bedroom: 0xFFF0F5, // Lavender blush
        kitchen: 0xF0FFF0, // Honeydew
        bathroom: 0xE0FFFF, // Light cyan
        dining: 0xFFF8DC,  // Cornsilk
        office: 0xF5F5DC,  // Beige
        garage: 0xD3D3D3   // Light gray
    };
    return colors[type] || 0xF5F5F5; // Default to white smoke
}

// Save current design to memory
function saveCurrentDesign() {
    currentDesign = {
        dimensions: {
            width: document.getElementById('house-width').value,
            depth: document.getElementById('house-depth').value,
            height: document.getElementById('house-height').value,
            roofType: document.getElementById('roof-type').value,
            roofHeight: document.getElementById('roof-height').value,
            style: document.getElementById('house-style').value
        },
        features: {
            entrance: document.getElementById('main-entrance').value,
            hasChimney: document.getElementById('has-chimney').checked,
            hasPorch: document.getElementById('has-porch').checked,
            hasGarage: document.getElementById('has-garage').checked
        },
        rooms: [],
        windows: [],
        doors: []
    };
    
    // Save rooms
    document.querySelectorAll('[id^="room-type-"]').forEach(el => {
        const id = el.id.split('-')[2];
        currentDesign.rooms.push({
            type: document.getElementById(`room-type-${id}`).value,
            width: document.getElementById(`room-width-${id}`).value,
            depth: document.getElementById(`room-depth-${id}`).value,
            x: document.getElementById(`room-x-${id}`).value,
            z: document.getElementById(`room-z-${id}`).value
        });
    });
    
    // Save windows
    document.querySelectorAll('[id^="window-wall-"]').forEach(el => {
        const id = el.id.split('-')[2];
        currentDesign.windows.push({
            wall: document.getElementById(`window-wall-${id}`).value,
            width: document.getElementById(`window-width-${id}`).value,
            height: document.getElementById(`window-height-${id}`).value,
            position: document.getElementById(`window-pos-${id}`).value
        });
    });
    
    // Save doors
    document.querySelectorAll('[id^="door-wall-"]').forEach(el => {
        const id = el.id.split('-')[2];
        currentDesign.doors.push({
            wall: document.getElementById(`door-wall-${id}`).value,
            width: document.getElementById(`door-width-${id}`).value,
            height: document.getElementById(`door-height-${id}`).value,
            position: document.getElementById(`door-pos-${id}`).value
        });
    });
}

// Save design to localStorage
function saveDesign() {
    saveCurrentDesign();
    localStorage.setItem('houseDesign', JSON.stringify(currentDesign));
    alert('Design saved successfully!');
}

// Load design from localStorage
function loadDesign() {
    const savedDesign = localStorage.getItem('houseDesign');
    if (!savedDesign) {
        alert('No saved design found!');
        return;
    }
    
    const design = JSON.parse(savedDesign);
    
    // Load dimensions and style
    document.getElementById('house-width').value = design.dimensions.width;
    document.getElementById('house-depth').value = design.dimensions.depth;
    document.getElementById('house-height').value = design.dimensions.height;
    document.getElementById('roof-type').value = design.dimensions.roofType;
    document.getElementById('roof-height').value = design.dimensions.roofHeight;
    document.getElementById('house-style').value = design.dimensions.style || 'modern';
    
    // Load features
    document.getElementById('main-entrance').value = design.features.entrance;
    document.getElementById('has-chimney').checked = design.features.hasChimney || false;
    document.getElementById('has-porch').checked = design.features.hasPorch || false;
    document.getElementById('has-garage').checked = design.features.hasGarage || false;
    
    // Clear existing rooms, windows, doors
    document.getElementById('rooms-container').innerHTML = '';
    document.getElementById('windows-container').innerHTML = '';
    document.getElementById('doors-container').innerHTML = '';
    
    // Load rooms
    design.rooms.forEach(room => {
        const roomId = Date.now();
        const html = `
        <div class="section" id="room-${roomId}">
            <div class="form-group">
                <label for="room-type-${roomId}">Room Type:</label>
                <select id="room-type-${roomId}" class="room-type">
                    <option value="living" ${room.type === 'living' ? 'selected' : ''}>Living Room</option>
                    <option value="bedroom" ${room.type === 'bedroom' ? 'selected' : ''}>Bedroom</option>
                    <option value="kitchen" ${room.type === 'kitchen' ? 'selected' : ''}>Kitchen</option>
                    <option value="bathroom" ${room.type === 'bathroom' ? 'selected' : ''}>Bathroom</option>
                    <option value="dining" ${room.type === 'dining' ? 'selected' : ''}>Dining Room</option>
                    <option value="office" ${room.type === 'office' ? 'selected' : ''}>Home Office</option>
                    <option value="garage" ${room.type === 'garage' ? 'selected' : ''}>Garage</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="room-width-${roomId}">Width (m):</label>
                <input type="number" id="room-width-${roomId}" min="2" max="20" value="${room.width}" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="room-depth-${roomId}">Depth (m):</label>
                <input type="number" id="room-depth-${roomId}" min="2" max="20" value="${room.depth}" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="room-x-${roomId}">X Position (m):</label>
                <input type="number" id="room-x-${roomId}" min="-20" max="20" value="${room.x}" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="room-z-${roomId}">Z Position (m):</label>
                <input type="number" id="room-z-${roomId}" min="-20" max="20" value="${room.z}" step="0.1">
            </div>
            
            <button class="remove-btn" onclick="document.getElementById('room-${roomId}').remove()">
                <i class="fas fa-trash"></i> Remove Room
            </button>
        </div>`;
        
        document.getElementById('rooms-container').insertAdjacentHTML('beforeend', html);
    });
    
    // Load windows
    design.windows.forEach(window => {
        const windowId = Date.now();
        const html = `
        <div class="feature-item" id="window-${windowId}">
            <div style="flex-grow: 1;">
                <div class="form-group" style="margin-bottom: 5px;">
                    <select id="window-wall-${windowId}" style="width: auto;">
                        <option value="north" ${window.wall === 'north' ? 'selected' : ''}>North Wall</option>
                        <option value="south" ${window.wall === 'south' ? 'selected' : ''}>South Wall</option>
                        <option value="east" ${window.wall === 'east' ? 'selected' : ''}>East Wall</option>
                        <option value="west" ${window.wall === 'west' ? 'selected' : ''}>West Wall</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Width</label>
                        <input type="number" id="window-width-${windowId}" min="0.5" max="5" value="${window.width}" step="0.1" style="width: 60px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Height</label>
                        <input type="number" id="window-height-${windowId}" min="0.5" max="3" value="${window.height}" step="0.1" style="width: 60px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Position</label>
                        <input type="number" id="window-pos-${windowId}" min="0" max="20" value="${window.position}" step="0.1" style="width: 60px;">
                    </div>
                </div>
            </div>
            <button class="remove-btn" onclick="document.getElementById('window-${windowId}').remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>`;
        
        document.getElementById('windows-container').insertAdjacentHTML('beforeend', html);
    });
    
    // Load doors
    design.doors.forEach(door => {
        const doorId = Date.now();
        const html = `
        <div class="feature-item" id="door-${doorId}">
            <div style="flex-grow: 1;">
                <div class="form-group" style="margin-bottom: 5px;">
                    <select id="door-wall-${doorId}" style="width: auto;">
                        <option value="north" ${door.wall === 'north' ? 'selected' : ''}>North Wall</option>
                        <option value="south" ${door.wall === 'south' ? 'selected' : ''}>South Wall</option>
                        <option value="east" ${door.wall === 'east' ? 'selected' : ''}>East Wall</option>
                        <option value="west" ${door.wall === 'west' ? 'selected' : ''}>West Wall</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Width</label>
                        <input type="number" id="door-width-${doorId}" min="0.5" max="2" value="${door.width}" step="0.1" style="width: 60px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Height</label>
                        <input type="number" id="door-height-${doorId}" min="1.5" max="3" value="${door.height}" step="0.1" style="width: 60px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Position</label>
                        <input type="number" id="door-pos-${doorId}" min="0" max="20" value="${door.position}" step="0.1" style="width: 60px;">
                    </div>
                </div>
            </div>
            <button class="remove-btn" onclick="document.getElementById('door-${doorId}').remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>`;
        
        document.getElementById('doors-container').insertAdjacentHTML('beforeend', html);
    });
    
    // Generate the house
    generateHouse();
}

// Initialize the application
window.onload = function() {
    init();
    addRoom();
    addWindow();
    addDoor();
    generateHouse();
    
    // Auto-update on form change
    document.querySelectorAll('#form-panel input, #form-panel select').forEach(el => {
        el.addEventListener('change', generateHouse);
    });
};
</script>
</body>
</html>